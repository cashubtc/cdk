name: FFI - Flutter Bindings

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  verify-flutter:
    name: Verify Flutter Bindings
    runs-on: ubuntu-latest
    steps:
      - name: Checkout CDK
        uses: actions/checkout@v4
        with:
          path: cdk

      - name: Checkout CDK Flutter
        uses: actions/checkout@v4
        with:
          repository: cashubtc/cdk_flutter
          path: cdk-flutter

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v17

      - name: Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: cdk

      - name: Install Flutter Rust Bridge Codegen
        run: |
          # Install the code generator
          cargo install flutter_rust_bridge_codegen --version 2.11.1

      - name: Patch Code and Dependencies
        run: |
          cd cdk-flutter/rust
          
          # 1. Patch Cargo.toml to point to local CDK
          sed -i 's/^cdk = { version = "[^"]*",/cdk = { path = "..\/..\/cdk\/crates\/cdk",/' Cargo.toml
          sed -i 's/^cdk-common = { version = "[^"]*",/cdk-common = { path = "..\/..\/cdk\/crates\/cdk-common",/' Cargo.toml
          sed -i 's/^cdk-sqlite = { version = "[^"]*",/cdk-sqlite = { path = "..\/..\/cdk\/crates\/cdk-sqlite",/' Cargo.toml
          
          echo "âœ… Patched Cargo.toml"

      - name: Verify Compilation
        run: |
          # 1. Install Dart dependencies
          cd cdk-flutter
          flutter pub get
          
          # 2. Setup environment
          cd rust
          # We use the CDK flake environment to ensure we have the right rustc/cargo
          # But we need to make sure flutter_rust_bridge_codegen is in PATH.
          export PATH=$HOME/.cargo/bin:$PATH
          
          # 3. Check Rust compilation first
          nix develop ../../cdk --command cargo check
          
          # 4. Generate bindings
          # This verifies that the Rust API changes are compatible with the binding generation logic
          nix develop ../../cdk --command flutter_rust_bridge_codegen generate

