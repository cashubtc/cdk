name: FFI - Flutter Bindings

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  verify-flutter:
    name: Verify Flutter Bindings
    runs-on: ubuntu-latest
    steps:
      - name: Checkout CDK
        uses: actions/checkout@v4
        with:
          path: cdk

      - name: Checkout CDK Flutter
        uses: actions/checkout@v4
        with:
          repository: cashubtc/cdk_flutter
          path: cdk-flutter

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v17

      - name: Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: cdk

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Patch Cargo Dependency
        run: |
          cd cdk-flutter/rust
          # Replace crates.io version with local path
          # We must point to the specific crate directory, not the workspace root
          
          # Patch cdk
          sed -i 's/^cdk = { version = "[^"]*",/cdk = { path = "..\/..\/cdk\/crates\/cdk",/' Cargo.toml
          
          # Patch cdk-common (to ensure we use the local version matching cdk)
          sed -i 's/^cdk-common = { version = "[^"]*",/cdk-common = { path = "..\/..\/cdk\/crates\/cdk-common",/' Cargo.toml
          
          # Patch cdk-sqlite (to ensure we use the local version matching cdk)
          sed -i 's/^cdk-sqlite = { version = "[^"]*",/cdk-sqlite = { path = "..\/..\/cdk\/crates\/cdk-sqlite",/' Cargo.toml
          
          # Verify the change
          echo "Patched Cargo.toml:"
          grep "^cdk" Cargo.toml

      - name: Verify Compilation
        run: |
          cd cdk-flutter/rust
          # Check ensures that the rust code compiles against the local CDK
          # Use CDK's flake for Rust environment
          nix develop ../../cdk --command cargo check
