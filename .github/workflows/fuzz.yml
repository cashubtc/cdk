name: Fuzz

on:
  schedule:
    - cron: "0 2 * * *" # Daily at 2am UTC
  workflow_dispatch: # Allow manual trigger

# Cancel previous runs on same ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  fuzz:
    name: "Fuzz: ${{ matrix.target }}"
    runs-on: self-hosted
    timeout-minutes: 90
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        target:
          - fuzz_token
          - fuzz_payment_request
          - fuzz_secret
          - fuzz_mint_url
          - fuzz_keyset_id
          - fuzz_proof
          - fuzz_blind_signature
          - fuzz_amount
          - fuzz_currency_unit
          - fuzz_spending_conditions
          - fuzz_htlc_witness
          - fuzz_token_raw_bytes
          - fuzz_p2pk_witness
          - fuzz_witness
          - fuzz_swap_request
          - fuzz_melt_request
          - fuzz_dleq
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Cachix
        uses: cachix/cachix-action@v16
        with:
          name: cashudevkit
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
          useDaemon: false
        continue-on-error: true
      - name: Fuzz ${{ matrix.target }}
        run: nix develop -i -L .#nightly --command just fuzz ${{ matrix.target }} 3600
