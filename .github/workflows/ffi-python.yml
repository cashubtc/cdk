name: FFI - Python Bindings

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  verify-python:
    name: Verify Python Bindings
    runs-on: ubuntu-latest
    steps:
      - name: Checkout CDK
        uses: actions/checkout@v4
        with:
          path: cdk

      - name: Checkout CDK Python
        uses: actions/checkout@v4
        with:
          repository: cashubtc/cdk-python
          path: cdk-python

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Install Just
        uses: extractions/setup-just@v1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install build dependencies
        run: |
          pip install build wheel uv
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config

      - name: Build Wheel
        run: |
          cd cdk-python
          chmod +x scripts/generate-linux-x86_64.sh
          # The script expects CDK at ./cdk or ../cdk. 
          # Since we checked out 'cdk' at root and 'cdk-python' at root, ../cdk works from inside cdk-python.
          ./scripts/generate-linux-x86_64.sh
          
          # Build the wheel
          python -m build --wheel

      - name: Verify
        run: |
          cd cdk-python
          uv venv
          source .venv/bin/activate
          
          # Install the built wheel
          # find dist/ -name "*.whl" | xargs uv pip install
          # Or install in editable mode if preferred, but wheel is better test of release artifact
          uv pip install dist/*.whl
          
          # Install test deps
          uv pip install pytest pytest-asyncio
          
          # Run tests
          pytest
